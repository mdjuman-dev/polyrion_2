/*! Deposit Modal - Production Optimized */
(function($){'use strict';$(function(){const $depositBtn=$("#depositBtn"),$depositModal=$("#depositModalPopup"),$depositOverlay=$("#depositModalOverlay"),$depositClose=$("#depositModalClose"),$depositAmount=$("#depositAmount"),$quickAmountBtns=$(".quick-amount-btn"),$methodBtns=$(".deposit-method-btn"),$depositSubmit=$("#depositSubmitBtn");function openDepositModal(){$depositModal.addClass("active");$depositOverlay.addClass("active");$("body").css("overflow","hidden")}function closeDepositModal(){$depositModal.removeClass("active");$depositOverlay.removeClass("active");$("body").css("overflow","")}window.openDepositModal=openDepositModal;window.closeDepositModal=closeDepositModal;$('#depositForm').on('submit',function(e){e.preventDefault();$('#depositSubmitBtn').trigger('click')});$depositBtn.on("click",function(e){e.preventDefault();openDepositModal()});$depositClose.on("click",function(e){e.preventDefault();closeDepositModal()});$depositOverlay.on("click",function(e){if($(e.target).is($depositOverlay)){closeDepositModal()}});$quickAmountBtns.on("click",function(){const amount=$(this).data("amount");$depositAmount.val(amount);$quickAmountBtns.removeClass("active");$(this).addClass("active")});$methodBtns.on("click",function(e){e.preventDefault();$methodBtns.removeClass("active");$(this).addClass("active");const method=$(this).data("method");if(method==='manual'){$("#queryCodeGroup").slideDown(200);$("#depositNoteText").text("Minimum deposit: $10. Enter your transaction code for manual verification.")}else{$("#queryCodeGroup").slideUp(200);$("#queryCode").val("");$("#depositNoteText").text("Minimum deposit: $10. Your payment will be processed securely.")}});$depositSubmit.on("click",function(e){e.preventDefault();const amount=parseFloat($depositAmount.val());const method=$methodBtns.filter('.active').data('method')||'binancepay';const currency='USDT';if(!amount||amount<=0){if(typeof showWarning!=='undefined'){showWarning('Please enter a valid amount','Invalid Amount')}else if(typeof Swal!=='undefined'){Swal.fire({icon:'warning',title:'Invalid Amount',text:'Please enter a valid amount',confirmButtonColor:'#ffb11a'})}else{alert('Please enter a valid amount')}return}if(amount<10){if(typeof showWarning!=='undefined'){showWarning('Minimum deposit amount is $10','Minimum Amount Required')}else if(typeof Swal!=='undefined'){Swal.fire({icon:'warning',title:'Minimum Amount Required',text:'Minimum deposit amount is $10',confirmButtonColor:'#ffb11a'})}else{alert('Minimum deposit amount is $10')}return}const $btn=$(this);const originalText=$btn.html();$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Processing...');if(method==='binancepay'){$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Creating payment...');$.ajax({url:'{{route("binance.create")}}',method:'POST',data:{amount:amount,currency:currency,_token:$('meta[name="csrf-token"]').attr('content')},success:function(response){if(response.success&&response.checkoutUrl){closeDepositModal();setTimeout(function(){window.location.href=response.checkoutUrl},100)}else{let errorMsg=response.message||"Failed to create payment. Please try again.";if(errorMsg.includes('IP')||errorMsg.includes('whitelist')){errorMsg+='\n\nPlease contact support to whitelist the server IP address.'}showError(errorMsg,'Payment Error');$btn.prop("disabled",false).html(originalText)}},error:function(xhr){let errorMessage="Failed to create payment. Please try again.";if(xhr.responseJSON&&xhr.responseJSON.message){errorMessage=xhr.responseJSON.message;if(errorMessage.includes('IP')||errorMessage.includes('whitelist')){errorMessage+='\n\nðŸ’¡ Tip: Server IP needs to be whitelisted in Binance Pay dashboard.'}else if(errorMessage.includes('authentication')||errorMessage.includes('API')){errorMessage+='\n\nðŸ’¡ Tip: Please check API credentials in admin settings.'}else if(errorMessage.includes('signature')){errorMessage+='\n\nðŸ’¡ Tip: Please verify API secret key is correct.'}}else if(xhr.responseJSON&&xhr.responseJSON.errors){const errors=Object.values(xhr.responseJSON.errors).flat();errorMessage=errors.join('\n')}else if(xhr.status===0){errorMessage="Network error. Please check your internet connection and try again."}else if(xhr.status===500){errorMessage="Server error. Please try again later or contact support."}showError(errorMessage,'Payment Error');$btn.prop("disabled",false).html(originalText)}});return}if(method==='manual'){const queryCode=$("#queryCode").val();if(!queryCode){showWarning('Please enter your transaction/query code','Query Code Required');$btn.prop("disabled",false).html(originalText);return}$.ajax({url:'{{route("binance.manual.verify")}}',method:'POST',data:{query_code:queryCode,amount:amount,_token:$('meta[name="csrf-token"]').attr('content')},success:function(response){if(response.success){showSuccess(response.message||`Payment verified! Your new balance is $${response.balance}`,'Payment Verified');$('.wallet-value').each(function(){if($(this).closest('.wallet-item').find('.wallet-label').text().trim()==='Cash'){$(this).text('$'+response.balance)}});$('.balance-value').text('$'+response.balance);closeDepositModal();$depositAmount.val("");$("#queryCode").val("");setTimeout(()=>{window.location.reload()},1500)}else{showError(response.message||"Verification failed. Please try again.",'Verification Failed')}},error:function(xhr){let errorMessage="Verification failed. Please try again.";if(xhr.responseJSON&&xhr.responseJSON.message){errorMessage=xhr.responseJSON.message}else if(xhr.responseJSON&&xhr.responseJSON.errors){const errors=Object.values(xhr.responseJSON.errors).flat();errorMessage=errors.join('\n')}showError(errorMessage,'Verification Failed')},complete:function(){$btn.prop("disabled",false).html(originalText)}});return}if(method==='metamask'||method==='trustwallet'){handleWeb3Deposit(amount,currency,$btn,originalText,method);return}showWarning('This payment method is not yet implemented','Coming Soon');$btn.prop("disabled",false).html(originalText)});$(document).on("keydown",function(e){if(e.key==="Escape"&&$depositModal.hasClass("active")){closeDepositModal()}});function getWeb3Provider(walletType){if(walletType==='trustwallet'){if(window.ethereum&&window.ethereum.isTrust){return window.ethereum}if(window.ethereum){return window.ethereum}return null}if(walletType==='metamask'){if(window.ethereum&&window.ethereum.isMetaMask){return window.ethereum}if(window.ethereum){return window.ethereum}return null}return null}function handleWeb3Deposit(amount,currency,$btn,originalText,walletType){const walletName=walletType==='trustwallet'?'Trust Wallet':'MetaMask';const provider=getWeb3Provider(walletType);if(!provider){const message=walletType==='trustwallet'?'Trust Wallet is not detected. Please open this page in Trust Wallet browser or install Trust Wallet extension.':'MetaMask is not installed. Please install MetaMask extension to continue.';if(typeof showError!=='undefined'){showError(message,walletName+' Required')}else if(typeof Swal!=='undefined'){Swal.fire({icon:'error',title:walletName+' Required',text:message,confirmButtonColor:'#ef4444'})}else{alert(message)}$btn.prop("disabled",false).html(originalText);return}const network='ethereum';const tokenAddress=null;function getUserAddress(){return new Promise(function(resolve,reject){provider.request({method:'eth_accounts'}).then(function(accounts){if(accounts&&accounts.length>0){resolve(accounts[0])}else{$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Opening '+walletName+'...');provider.request({method:'eth_requestAccounts'}).then(function(requestedAccounts){if(!requestedAccounts||requestedAccounts.length===0){reject(new Error('No accounts found. Please unlock '+walletName+'.'))}else{resolve(requestedAccounts[0])}}).catch(reject)}}).catch(reject)})}$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Connecting...');getUserAddress().then(function(userAddress){$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Creating deposit...');return $.ajax({url:'{{route("metamask.deposit.create")}}',method:'POST',data:{amount:amount,currency:currency||'USDT',network:network,token_address:tokenAddress,wallet_type:walletType,_token:$('meta[name="csrf-token"]').attr('content')}}).then(function(createDepositResponse){if(!createDepositResponse.success){throw new Error(createDepositResponse.message||"Failed to create deposit")}return{response:createDepositResponse,userAddress:userAddress}})}).then(function(data){const response=data.response;const userAddress=data.userAddress;const merchantAddress=response.merchant_address;const decimals=response.token_decimals||18;const amountFloat=parseFloat(amount);let amountInWei;if(typeof BigInt!=='undefined'){const multiplier=BigInt(10)**BigInt(decimals);const amountBigInt=BigInt(Math.floor(amountFloat*Math.pow(10,decimals)));amountInWei=amountBigInt}else{amountInWei=Math.floor(amountFloat*Math.pow(10,decimals))}const amountHex='0x'+amountInWei.toString(16);$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Opening '+walletName+'...');return provider.request({method:'eth_gasPrice'}).then(function(gasPrice){return provider.request({method:'eth_estimateGas',params:[{from:userAddress,to:merchantAddress,value:amountHex}]}).catch(function(){return'0x5208'}).then(function(gasLimit){const transactionParameters={from:userAddress,to:merchantAddress,value:amountHex,gas:gasLimit,gasPrice:gasPrice};return provider.request({method:'eth_sendTransaction',params:[transactionParameters]}).then(function(txHash){return{txHash:txHash,depositId:response.deposit_id}})})})}).then(function(result){const txHash=result.txHash;const depositId=result.depositId;if(!txHash){throw new Error('Transaction failed. No transaction hash returned.')}closeDepositModal();if(typeof showSuccess!=='undefined'){showSuccess(`Transaction sent! Hash: ${txHash.substring(0,10)}...${txHash.substring(txHash.length-8)}. Please wait for confirmation...`,'Transaction Sent')}else if(typeof Swal!=='undefined'){Swal.fire({title:'Transaction Sent!',html:`<div style="text-align: left; color: var(--text-primary, #333);"><p style="color: var(--text-primary, #333); margin-bottom: 10px;"><strong>Transaction Hash:</strong></p><div style="background: var(--secondary, #f5f5f5); color: var(--text-primary, #333); padding: 12px; border-radius: 8px; word-break: break-all; font-family: 'Courier New', monospace; margin: 10px 0; font-size: 13px; border: 1px solid var(--border, #ddd);">${txHash}</div><p style="margin-top: 15px; color: var(--text-primary, #333);">Your transaction has been sent. Please wait for confirmation...</p></div>`,icon:'success',showConfirmButton:true,confirmButtonText:'OK',confirmButtonColor:'#3085d6',allowOutsideClick:false})}verifyWeb3Transaction(txHash,depositId,network,$btn,originalText)}).catch(function(error){let errorMessage='Failed to process payment. Please try again.';if(error.code===4001){errorMessage='Transaction was rejected. Please try again.'}else if(error.code===-32002){errorMessage='A request is already pending in '+walletName+'. Please check your wallet.'}else if(error.code===-32603){errorMessage='Internal error. Please try again.'}else if(error.message){errorMessage=error.message}else if(error.responseJSON&&error.responseJSON.message){errorMessage=error.responseJSON.message}showError(errorMessage,'Payment Error');$btn.prop("disabled",false).html(originalText)})}function verifyWeb3Transaction(txHash,depositId,network,$btn,originalText){$btn.prop("disabled",true).html('<i class="fas fa-spinner fa-spin"></i> Verifying...');checkTransactionStatus(txHash,network,depositId,$btn,originalText,0)}function checkTransactionStatus(txHash,network,depositId,$btn,originalText,attempt){const maxAttempts=60;$.ajax({url:'{{route("metamask.transaction.status")}}',method:'POST',data:{tx_hash:txHash,network:network,_token:$('meta[name="csrf-token"]').attr('content')},success:function(response){if(response.success&&response.status==='success'){verifyTransaction(txHash,depositId,network,$btn,originalText)}else if(response.success&&response.status==='pending'){if(attempt<maxAttempts){setTimeout(()=>{checkTransactionStatus(txHash,network,depositId,$btn,originalText,attempt+1)},5000)}else{showError('Transaction is taking too long to confirm. Please verify manually later.','Timeout');$btn.prop("disabled",false).html(originalText)}}else{showError(response.message||'Transaction verification failed','Error');$btn.prop("disabled",false).html(originalText)}},error:function(){verifyTransaction(txHash,depositId,network,$btn,originalText)}})}function verifyTransaction(txHash,depositId,network,$btn,originalText){$.ajax({url:'{{route("metamask.transaction.verify")}}',method:'POST',data:{tx_hash:txHash,deposit_id:depositId,network:network,_token:$('meta[name="csrf-token"]').attr('content')},success:function(response){if(response.success){showSuccess(response.message||`Payment verified! Your new balance is $${response.balance}`,'Payment Verified');$('.wallet-value').each(function(){if($(this).closest('.wallet-item').find('.wallet-label').text().trim()==='Cash'){$(this).text('$'+response.balance)}});$('.balance-value').text('$'+response.balance);closeDepositModal();$depositAmount.val("");setTimeout(()=>{window.location.reload()},1500)}else{showError(response.message||"Verification failed. Please try again.",'Verification Failed');$btn.prop("disabled",false).html(originalText)}},error:function(xhr){let errorMessage="Verification failed. Please try again.";if(xhr.responseJSON&&xhr.responseJSON.message){errorMessage=xhr.responseJSON.message}showError(errorMessage,'Verification Failed');$btn.prop("disabled",false).html(originalText)}})}})})(jQuery);

