/*! Google Translate Integration - Production Optimized */
(function() {
    'use strict';
    
    // Language configuration
    const DEFAULT_LANGUAGE = 'en';
    const STORAGE_KEY = 'google_translate_language';
    
    // Popular languages (shown initially)
    const POPULAR_LANGUAGES = {
        'en': { name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
        'bn': { name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
        'es': { name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
        'fr': { name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
        'de': { name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
        'hi': { name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' }
    };
    
    // All available languages
    const ALL_LANGUAGES = {
        'en': { name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
        'bn': { name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
        'es': { name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
        'fr': { name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
        'de': { name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
        'it': { name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
        'pt': { name: 'Portuguese', flag: 'ðŸ‡µðŸ‡¹' },
        'ru': { name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' },
        'ja': { name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
        'ko': { name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' },
        'zh-CN': { name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
        'zh-TW': { name: 'Chinese Traditional', flag: 'ðŸ‡¹ðŸ‡¼' },
        'ar': { name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' },
        'hi': { name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' },
        'nl': { name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' },
        'pl': { name: 'Polish', flag: 'ðŸ‡µðŸ‡±' },
        'tr': { name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' },
        'vi': { name: 'Vietnamese', flag: 'ðŸ‡»ðŸ‡³' },
        'th': { name: 'Thai', flag: 'ðŸ‡¹ðŸ‡­' },
        'id': { name: 'Indonesian', flag: 'ðŸ‡®ðŸ‡©' },
        'cs': { name: 'Czech', flag: 'ðŸ‡¨ðŸ‡¿' },
        'sv': { name: 'Swedish', flag: 'ðŸ‡¸ðŸ‡ª' },
        'da': { name: 'Danish', flag: 'ðŸ‡©ðŸ‡°' },
        'fi': { name: 'Finnish', flag: 'ðŸ‡«ðŸ‡®' },
        'no': { name: 'Norwegian', flag: 'ðŸ‡³ðŸ‡´' },
        'he': { name: 'Hebrew', flag: 'ðŸ‡®ðŸ‡±' },
        'uk': { name: 'Ukrainian', flag: 'ðŸ‡ºðŸ‡¦' },
        'ro': { name: 'Romanian', flag: 'ðŸ‡·ðŸ‡´' },
        'hu': { name: 'Hungarian', flag: 'ðŸ‡­ðŸ‡º' },
        'el': { name: 'Greek', flag: 'ðŸ‡¬ðŸ‡·' },
        'bg': { name: 'Bulgarian', flag: 'ðŸ‡§ðŸ‡¬' },
        'hr': { name: 'Croatian', flag: 'ðŸ‡­ðŸ‡·' },
        'sk': { name: 'Slovak', flag: 'ðŸ‡¸ðŸ‡°' },
        'sl': { name: 'Slovenian', flag: 'ðŸ‡¸ðŸ‡®' },
        'bn': { name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
        'ur': { name: 'Urdu', flag: 'ðŸ‡µðŸ‡°' },
        'fa': { name: 'Persian', flag: 'ðŸ‡®ðŸ‡·' },
        'ms': { name: 'Malay', flag: 'ðŸ‡²ðŸ‡¾' },
        'ta': { name: 'Tamil', flag: 'ðŸ‡®ðŸ‡³' },
        'te': { name: 'Telugu', flag: 'ðŸ‡®ðŸ‡³' },
        'mr': { name: 'Marathi', flag: 'ðŸ‡®ðŸ‡³' }
    };
    
    let currentLanguage = DEFAULT_LANGUAGE;
    let googleTranslateLoaded = false;
    let translateInstance = null;
    let showAllLanguages = false;
    
    // Get saved language
    function getSavedLanguage() {
        try {
            return localStorage.getItem(STORAGE_KEY) || DEFAULT_LANGUAGE;
        } catch (e) {
            return DEFAULT_LANGUAGE;
        }
    }
    
    // Save language preference
    function saveLanguage(lang) {
        try {
            localStorage.setItem(STORAGE_KEY, lang);
            currentLanguage = lang;
        } catch (e) {
            console.warn('Could not save language preference:', e);
        }
    }
    
    // Hide Google Translate banner
    function hideTranslateBanner() {
        const style = document.createElement('style');
        style.id = 'google-translate-hide-style';
        if (document.getElementById('google-translate-hide-style')) return;
        
        style.textContent = `
            .goog-te-banner-frame,
            .goog-te-banner-frame.skiptranslate,
            #google_translate_element .goog-te-banner-frame,
            .skiptranslate {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                max-height: 0 !important;
                overflow: hidden !important;
            }
            body {
                top: 0 !important;
            }
            .goog-te-menu-frame {
                z-index: 100000 !important;
            }
        `;
        document.head.appendChild(style);
        
        // Hide banner via DOM
        const observer = new MutationObserver(function() {
            const banner = document.querySelector('.goog-te-banner-frame');
            if (banner) {
                banner.style.display = 'none';
                banner.style.visibility = 'hidden';
                banner.style.height = '0';
            }
            if (document.body.style.top && document.body.style.top !== '0px') {
                document.body.style.top = '0px';
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });
    }
    
    // Initialize Google Translate with error handling
    function initGoogleTranslate() {
        if (googleTranslateLoaded) return;
        
        // Check if Google Translate is blocked
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        script.async = true;
        script.onerror = function() {
            console.warn('Google Translate script blocked. Using fallback method.');
            googleTranslateLoaded = false;
        };
        
        // Define callback
        window.googleTranslateElementInit = function() {
            try {
                if (!window.google || !window.google.translate) {
                    throw new Error('Google Translate not available');
                }
                
                googleTranslateLoaded = true;
                
                new google.translate.TranslateElement({
                    pageLanguage: DEFAULT_LANGUAGE,
                    includedLanguages: Object.keys(ALL_LANGUAGES).join(','),
                    layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                    autoDisplay: false
                }, 'google_translate_element');
                
                // Wait for element to be created with multiple attempts
                let attempts = 0;
                const findElement = setInterval(function() {
                    attempts++;
                    
                    // Try multiple selectors
                    translateInstance = document.querySelector('.goog-te-combo') || 
                                       document.querySelector('select.goog-te-combo') ||
                                       document.querySelector('#google_translate_element select') ||
                                       document.querySelector('#google_translate_element .goog-te-combo');
                    
                    if (translateInstance) {
                        clearInterval(findElement);
                        console.log('Google Translate element found');
                        
                        const savedLang = getSavedLanguage();
                        if (savedLang !== DEFAULT_LANGUAGE) {
                            // Set cookie for saved language but don't reload
                            // Let Google Translate handle it automatically
                            setLanguageCookie(savedLang);
                            
                            // Try to change language via element
                            setTimeout(function() {
                                if (translateInstance) {
                                    try {
                                        translateInstance.value = savedLang;
                                        const changeEvent = new Event('change', { bubbles: true });
                                        translateInstance.dispatchEvent(changeEvent);
                                    } catch (e) {
                                        console.log('Could not change language via element');
                                    }
                                }
                            }, 500);
                        }
                        hideTranslateBanner();
                    } else if (attempts > 50) {
                        clearInterval(findElement);
                        console.warn('Google Translate element not found after 5 seconds');
                        
                        // Even if element not found, set cookie for saved language
                        const savedLang = getSavedLanguage();
                        if (savedLang !== DEFAULT_LANGUAGE) {
                            setLanguageCookie(savedLang);
                        }
                        
                        // Hide banner anyway
                        hideTranslateBanner();
                    }
                }, 100);
            } catch (e) {
                console.warn('Google Translate initialization failed:', e);
                googleTranslateLoaded = false;
            }
        };
        
        document.head.appendChild(script);
        
        // Fallback: Hide banner after timeout
        setTimeout(hideTranslateBanner, 500);
    }
    
    // Change language programmatically
    function changeLanguage(lang) {
        console.log('Changing language to:', lang);
        
        // Save language preference first
        saveLanguage(lang);
        currentLanguage = lang;
        updateLanguageSwitcher(lang);
        
        if (lang === DEFAULT_LANGUAGE) {
            // Reset to English - clear cookie
            setLanguageCookie(DEFAULT_LANGUAGE);
            
            // Try to reset via element first
            if (translateInstance) {
                try {
                    translateInstance.value = '';
                    const changeEvent = new Event('change', { bubbles: true });
                    translateInstance.dispatchEvent(changeEvent);
                    console.log('Reset to English via element');
                    return;
                } catch (e) {
                    console.log('Could not reset via element, reloading...');
                }
            }
            
            // If element method fails, reload
            setTimeout(function() {
                window.location.reload();
            }, 200);
            return;
        }
        
        // Initialize Google Translate if not loaded
        if (!googleTranslateLoaded) {
            initGoogleTranslate();
            // Wait for it to load, then change language
            let waitAttempts = 0;
            const waitForLoad = setInterval(function() {
                waitAttempts++;
                if (googleTranslateLoaded || waitAttempts > 30) {
                    clearInterval(waitForLoad);
                    if (googleTranslateLoaded) {
                        setTimeout(function() {
                            changeLanguage(lang);
                        }, 500);
                    } else {
                        // If can't load, set cookie and wait - don't reload immediately
                        setLanguageCookie(lang);
                        console.log('Google Translate not loaded, cookie set. Page will translate on next load.');
                    }
                }
            }, 100);
            return;
        }
        
        // Method 1: Use cookie to set language (most reliable)
        setLanguageCookie(lang);
        
        // Method 2: Try to use the translate element
        const checkAndTranslate = function(attempts) {
            attempts = attempts || 0;
            
            if (attempts > 20) {
                // If element not found after many attempts, reload as last resort
                console.log('Element not found, reloading page with cookie as fallback...');
                setTimeout(function() {
                    window.location.reload();
                }, 300);
                return;
            }
            
            // Try multiple selectors
            if (!translateInstance) {
                translateInstance = document.querySelector('.goog-te-combo') ||
                                   document.querySelector('select.goog-te-combo') ||
                                   document.querySelector('#google_translate_element select');
            }
            
            if (translateInstance) {
                try {
                    // Set the language value
                    translateInstance.value = lang;
                    
                    // Create and dispatch change event
                    const changeEvent = new Event('change', { 
                        bubbles: true, 
                        cancelable: true 
                    });
                    translateInstance.dispatchEvent(changeEvent);
                    
                    // Also try input event
                    const inputEvent = new Event('input', { 
                        bubbles: true, 
                        cancelable: true 
                    });
                    translateInstance.dispatchEvent(inputEvent);
                    
                    // Try native change handler
                    if (typeof translateInstance.onchange === 'function') {
                        translateInstance.onchange();
                    }
                    
                    // Try jQuery if available
                    if (typeof jQuery !== 'undefined') {
                        jQuery(translateInstance).val(lang).trigger('change');
                    }
                    
                    console.log('Language changed via element to:', lang);
                    
                } catch (e) {
                    console.error('Error changing language via element:', e);
                }
                
                // Don't reload - translation should work via element
                // Only reload if translation doesn't happen after 2 seconds
                setTimeout(function() {
                    // Check if translation actually happened
                    const bodyLang = document.body.getAttribute('lang') || 
                                   document.documentElement.getAttribute('lang') ||
                                   document.querySelector('html').getAttribute('lang');
                    
                    // If still in English and we changed to another language, reload
                    if (lang !== DEFAULT_LANGUAGE && (!bodyLang || bodyLang === DEFAULT_LANGUAGE)) {
                        console.log('Translation did not apply, reloading...');
                        window.location.reload();
                    }
                }, 2000);
                
            } else {
                // Element not found yet, keep trying
                setTimeout(function() {
                    checkAndTranslate(attempts + 1);
                }, 100);
            }
        };
        
        checkAndTranslate();
    }
    
    // Set Google Translate cookie (most reliable method)
    function setLanguageCookie(lang) {
        if (lang === DEFAULT_LANGUAGE) {
            // Clear cookie for English - try multiple ways
            const pastDate = 'Thu, 01 Jan 1970 00:00:00 UTC';
            document.cookie = 'googtrans=; expires=' + pastDate + '; path=/;';
            document.cookie = 'googtrans=; expires=' + pastDate + '; path=/; domain=' + window.location.hostname;
            if (window.location.hostname.indexOf('.') > 0) {
                const domain = '.' + window.location.hostname.split('.').slice(-2).join('.');
                document.cookie = 'googtrans=; expires=' + pastDate + '; path=/; domain=' + domain;
            }
            console.log('Cleared language cookie for English');
        } else {
            // Set cookie for target language: format is "en|bn" (from|to)
            const cookieValue = DEFAULT_LANGUAGE + '|' + lang;
            const expires = new Date();
            expires.setTime(expires.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 year
            const expiresString = expires.toUTCString();
            
            // Set cookie for current path
            document.cookie = 'googtrans=' + cookieValue + '; expires=' + expiresString + '; path=/;';
            
            // Set for current domain
            document.cookie = 'googtrans=' + cookieValue + '; expires=' + expiresString + '; path=/; domain=' + window.location.hostname;
            
            // Set for parent domain if subdomain
            if (window.location.hostname.indexOf('.') > 0) {
                const domain = '.' + window.location.hostname.split('.').slice(-2).join('.');
                document.cookie = 'googtrans=' + cookieValue + '; expires=' + expiresString + '; path=/; domain=' + domain;
            }
            
            console.log('Set Google Translate cookie:', cookieValue);
            
            // Verify cookie was set
            const cookies = document.cookie.split(';');
            const googtransCookie = cookies.find(function(c) {
                return c.trim().startsWith('googtrans=');
            });
            if (googtransCookie) {
                console.log('Cookie verified:', googtransCookie.trim());
            } else {
                console.warn('Cookie might not have been set properly');
            }
        }
    }
    
    // Update language switcher UI
    function updateLanguageSwitcher(lang) {
        const switchers = [
            document.getElementById('languageSwitcher'),
            document.getElementById('languageSwitcherMobile')
        ].filter(function(switcher) { return switcher !== null; });
        
        if (switchers.length === 0) return;
        
        const currentLang = ALL_LANGUAGES[lang] || POPULAR_LANGUAGES[DEFAULT_LANGUAGE];
        
        switchers.forEach(function(switcher) {
            const button = switcher.querySelector('.language-switcher-button');
            const dropdown = switcher.querySelector('.language-switcher-dropdown');
            
            if (button) {
                const flagSpan = button.querySelector('.language-flag');
                const nameSpan = button.querySelector('.language-name');
                if (flagSpan) flagSpan.textContent = currentLang.flag;
                if (nameSpan) nameSpan.textContent = currentLang.name;
            }
            
            if (dropdown) {
                const items = dropdown.querySelectorAll('.language-item');
                items.forEach(function(item) {
                    const itemLang = item.getAttribute('data-lang');
                    if (itemLang === lang) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        });
    }
    
    // Render language items
    function renderLanguageItems(container, languages, showSearch) {
        if (!container) return;
        
        container.innerHTML = '';
        
        // Add search box if showing all languages
        if (showSearch && showAllLanguages) {
            const searchBox = document.createElement('div');
            searchBox.className = 'language-search-box';
            searchBox.innerHTML = `
                <input type="text" class="language-search-input" placeholder="Search language..." autocomplete="off">
            `;
            container.appendChild(searchBox);
            
            const searchInput = searchBox.querySelector('.language-search-input');
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                const items = container.querySelectorAll('.language-item');
                items.forEach(function(item) {
                    const name = item.querySelector('.language-item-name').textContent.toLowerCase();
                    item.style.display = name.includes(query) ? '' : 'none';
                });
            });
        }
        
        // Add language items
        Object.keys(languages).forEach(function(langCode) {
            const lang = languages[langCode];
            const item = document.createElement('div');
            item.className = 'language-item';
            item.setAttribute('data-lang', langCode);
            if (currentLanguage === langCode) {
                item.classList.add('active');
            }
            item.innerHTML = `
                <span class="language-item-flag">${lang.flag}</span>
                <span class="language-item-name">${lang.name}</span>
            `;
            container.appendChild(item);
        });
        
        // Add "Show more" button if showing popular languages
        if (!showAllLanguages && Object.keys(languages).length < Object.keys(ALL_LANGUAGES).length) {
            const showMoreBtn = document.createElement('div');
            showMoreBtn.className = 'language-show-more';
            showMoreBtn.innerHTML = `
                <i class="fas fa-search"></i>
                <span>Search more languages...</span>
            `;
            showMoreBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showAllLanguages = true;
                renderLanguageItems(container, ALL_LANGUAGES, true);
            });
            container.appendChild(showMoreBtn);
        }
    }
    
    // Initialize language switcher
    function initLanguageSwitcher() {
        const switchers = [
            document.getElementById('languageSwitcher'),
            document.getElementById('languageSwitcherMobile')
        ].filter(function(switcher) { return switcher !== null; });
        
        if (switchers.length === 0) return;
        
        switchers.forEach(function(switcher) {
            const button = switcher.querySelector('.language-switcher-button');
            const dropdown = switcher.querySelector('.language-switcher-dropdown');
            
            if (!button || !dropdown) return;
            
            // Initial render with popular languages
            renderLanguageItems(dropdown, POPULAR_LANGUAGES, false);
            
            // Toggle dropdown
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                switchers.forEach(function(otherSwitcher) {
                    if (otherSwitcher !== switcher) {
                        otherSwitcher.querySelector('.language-switcher-dropdown').classList.remove('active');
                    }
                });
                dropdown.classList.toggle('active');
            });
            
            // Handle language selection
            dropdown.addEventListener('click', function(e) {
                const item = e.target.closest('.language-item');
                if (item) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const lang = item.getAttribute('data-lang');
                    if (lang) {
                        changeLanguage(lang);
                        switchers.forEach(function(s) {
                            s.querySelector('.language-switcher-dropdown').classList.remove('active');
                        });
                        
                        document.body.style.transition = 'opacity 0.3s ease';
                        document.body.style.opacity = '0.95';
                        setTimeout(function() {
                            document.body.style.opacity = '1';
                        }, 300);
                    }
                }
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            switchers.forEach(function(switcher) {
                if (!switcher.contains(e.target)) {
                    switcher.querySelector('.language-switcher-dropdown').classList.remove('active');
                }
            });
        });
        
        // Initialize with saved language
        const savedLang = getSavedLanguage();
        updateLanguageSwitcher(savedLang);
        currentLanguage = savedLang;
    }
    
    // Translate dynamic content
    function translateDynamicContent() {
        if (currentLanguage === DEFAULT_LANGUAGE || !googleTranslateLoaded) return;
        
        setTimeout(function() {
            if (translateInstance && currentLanguage !== DEFAULT_LANGUAGE) {
                try {
                    const tempLang = translateInstance.value;
                    translateInstance.value = '';
                    setTimeout(function() {
                        translateInstance.value = currentLanguage;
                        translateInstance.dispatchEvent(new Event('change'));
                    }, 50);
                } catch (e) {
                    // Ignore errors
                }
            }
        }, 300);
    }
    
    // Watch for AJAX updates
    function watchForAjaxUpdates() {
        if (window.Livewire) {
            document.addEventListener('livewire:navigated', function() {
                setTimeout(translateDynamicContent, 500);
            });
        }
        
        const observer = new MutationObserver(function(mutations) {
            let shouldTranslate = false;
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && 
                            (node.classList.contains('market-card') || 
                             node.classList.contains('outcome-row') ||
                             node.classList.contains('table') ||
                             node.querySelector('.market-card, .outcome-row, .table'))) {
                            shouldTranslate = true;
                        }
                    });
                }
            });
            
            if (shouldTranslate) {
                translateDynamicContent();
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    
    // Initialize header menu language items
    function initHeaderMenuLanguageItems() {
        const desktopItem = document.getElementById('headerMenuLanguageItem');
        const mobileItem = document.getElementById('headerMenuLanguageItemMobile');
        const sidebarItem = document.getElementById('sidebarMenuLanguageItem');
        
        function handleLanguageMenuClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const headerMenu = document.getElementById('headerMenuDropdown');
            if (headerMenu) {
                headerMenu.classList.remove('active');
            }
            
            const sidebarMenu = document.getElementById('moreMenuSidebar');
            const sidebarOverlay = document.getElementById('moreMenuOverlay');
            if (sidebarMenu) {
                sidebarMenu.classList.remove('active');
            }
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('active');
            }
            if (document.body) {
                document.body.style.overflow = '';
            }
            
            const desktopSwitcher = document.getElementById('languageSwitcher');
            const mobileSwitcher = document.getElementById('languageSwitcherMobile');
            const activeSwitcher = desktopSwitcher || mobileSwitcher;
            
            if (activeSwitcher) {
                const dropdown = activeSwitcher.querySelector('.language-switcher-dropdown');
                if (dropdown) {
                    dropdown.classList.add('active');
                    if (mobileSwitcher && window.innerWidth <= 991) {
                        setTimeout(function() {
                            mobileSwitcher.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                }
            }
        }
        
        if (desktopItem) {
            desktopItem.addEventListener('click', handleLanguageMenuClick);
        }
        if (mobileItem) {
            mobileItem.addEventListener('click', handleLanguageMenuClick);
        }
        if (sidebarItem) {
            sidebarItem.addEventListener('click', handleLanguageMenuClick);
        }
    }
    
    // Initialize
    function init() {
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
            return;
        }
        
        initLanguageSwitcher();
        initHeaderMenuLanguageItems();
        initGoogleTranslate();
        watchForAjaxUpdates();
        setInterval(hideTranslateBanner, 1000);
    }
    
    // Expose public API
    window.GoogleTranslateManager = {
        changeLanguage: changeLanguage,
        getCurrentLanguage: function() { return currentLanguage; },
        getLanguages: function() { return ALL_LANGUAGES; }
    };
    
    init();
})();
