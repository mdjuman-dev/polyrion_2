/*! Google Translate Integration - Production Optimized */
(function() {
    'use strict';
    
    // Language configuration
    const DEFAULT_LANGUAGE = 'en';
    const STORAGE_KEY = 'google_translate_language';
    
    // Popular languages (shown initially)
    const POPULAR_LANGUAGES = {
        'en': { name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
        'bn': { name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
        'es': { name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
        'fr': { name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
        'de': { name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
        'hi': { name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' }
    };
    
    // All available languages
    const ALL_LANGUAGES = {
        'en': { name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
        'bn': { name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
        'es': { name: 'Spanish', flag: 'ðŸ‡ªðŸ‡¸' },
        'fr': { name: 'French', flag: 'ðŸ‡«ðŸ‡·' },
        'de': { name: 'German', flag: 'ðŸ‡©ðŸ‡ª' },
        'it': { name: 'Italian', flag: 'ðŸ‡®ðŸ‡¹' },
        'pt': { name: 'Portuguese', flag: 'ðŸ‡µðŸ‡¹' },
        'ru': { name: 'Russian', flag: 'ðŸ‡·ðŸ‡º' },
        'ja': { name: 'Japanese', flag: 'ðŸ‡¯ðŸ‡µ' },
        'ko': { name: 'Korean', flag: 'ðŸ‡°ðŸ‡·' },
        'zh-CN': { name: 'Chinese', flag: 'ðŸ‡¨ðŸ‡³' },
        'zh-TW': { name: 'Chinese Traditional', flag: 'ðŸ‡¹ðŸ‡¼' },
        'ar': { name: 'Arabic', flag: 'ðŸ‡¸ðŸ‡¦' },
        'hi': { name: 'Hindi', flag: 'ðŸ‡®ðŸ‡³' },
        'nl': { name: 'Dutch', flag: 'ðŸ‡³ðŸ‡±' },
        'pl': { name: 'Polish', flag: 'ðŸ‡µðŸ‡±' },
        'tr': { name: 'Turkish', flag: 'ðŸ‡¹ðŸ‡·' },
        'vi': { name: 'Vietnamese', flag: 'ðŸ‡»ðŸ‡³' },
        'th': { name: 'Thai', flag: 'ðŸ‡¹ðŸ‡­' },
        'id': { name: 'Indonesian', flag: 'ðŸ‡®ðŸ‡©' },
        'cs': { name: 'Czech', flag: 'ðŸ‡¨ðŸ‡¿' },
        'sv': { name: 'Swedish', flag: 'ðŸ‡¸ðŸ‡ª' },
        'da': { name: 'Danish', flag: 'ðŸ‡©ðŸ‡°' },
        'fi': { name: 'Finnish', flag: 'ðŸ‡«ðŸ‡®' },
        'no': { name: 'Norwegian', flag: 'ðŸ‡³ðŸ‡´' },
        'he': { name: 'Hebrew', flag: 'ðŸ‡®ðŸ‡±' },
        'uk': { name: 'Ukrainian', flag: 'ðŸ‡ºðŸ‡¦' },
        'ro': { name: 'Romanian', flag: 'ðŸ‡·ðŸ‡´' },
        'hu': { name: 'Hungarian', flag: 'ðŸ‡­ðŸ‡º' },
        'el': { name: 'Greek', flag: 'ðŸ‡¬ðŸ‡·' },
        'bg': { name: 'Bulgarian', flag: 'ðŸ‡§ðŸ‡¬' },
        'hr': { name: 'Croatian', flag: 'ðŸ‡­ðŸ‡·' },
        'sk': { name: 'Slovak', flag: 'ðŸ‡¸ðŸ‡°' },
        'sl': { name: 'Slovenian', flag: 'ðŸ‡¸ðŸ‡®' },
        'bn': { name: 'Bengali', flag: 'ðŸ‡§ðŸ‡©' },
        'ur': { name: 'Urdu', flag: 'ðŸ‡µðŸ‡°' },
        'fa': { name: 'Persian', flag: 'ðŸ‡®ðŸ‡·' },
        'ms': { name: 'Malay', flag: 'ðŸ‡²ðŸ‡¾' },
        'ta': { name: 'Tamil', flag: 'ðŸ‡®ðŸ‡³' },
        'te': { name: 'Telugu', flag: 'ðŸ‡®ðŸ‡³' },
        'mr': { name: 'Marathi', flag: 'ðŸ‡®ðŸ‡³' }
    };
    
    let currentLanguage = DEFAULT_LANGUAGE;
    let googleTranslateLoaded = false;
    let translateInstance = null;
    let showAllLanguages = false;
    let isReloading = false; // Prevent multiple reloads
    
    // Get saved language
    function getSavedLanguage() {
        try {
            return localStorage.getItem(STORAGE_KEY) || DEFAULT_LANGUAGE;
        } catch (e) {
            return DEFAULT_LANGUAGE;
        }
    }
    
    // Save language preference
    function saveLanguage(lang) {
        try {
            localStorage.setItem(STORAGE_KEY, lang);
            currentLanguage = lang;
        } catch (e) {
            console.warn('Could not save language preference:', e);
        }
    }
    
    // Hide Google Translate banner
    function hideTranslateBanner() {
        const style = document.createElement('style');
        style.id = 'google-translate-hide-style';
        if (document.getElementById('google-translate-hide-style')) return;
        
        style.textContent = `
            .goog-te-banner-frame,
            .goog-te-banner-frame.skiptranslate,
            #google_translate_element .goog-te-banner-frame,
            .skiptranslate {
                display: none !important;
                visibility: hidden !important;
                height: 0 !important;
                max-height: 0 !important;
                overflow: hidden !important;
            }
            body {
                top: 0 !important;
            }
            .goog-te-menu-frame {
                z-index: 100000 !important;
            }
        `;
        document.head.appendChild(style);
        
        // Hide banner via DOM
        const observer = new MutationObserver(function() {
            const banner = document.querySelector('.goog-te-banner-frame');
            if (banner) {
                banner.style.display = 'none';
                banner.style.visibility = 'hidden';
                banner.style.height = '0';
            }
            if (document.body.style.top && document.body.style.top !== '0px') {
                document.body.style.top = '0px';
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true,
            attributes: true,
            attributeFilter: ['style', 'class']
        });
    }
    
    // Find and apply translation element after initialization
    function findAndApplyTranslateElement(retryCount) {
        retryCount = retryCount || 0;
        const maxRetries = 20; // Maximum 10 seconds (20 * 500ms)
        
        // Try multiple selectors
        translateInstance = document.querySelector('.goog-te-combo') || 
                           document.querySelector('select.goog-te-combo') ||
                           document.querySelector('#google_translate_element select') ||
                           document.querySelector('#google_translate_element .goog-te-combo');
        
        if (translateInstance) {
            console.log('Google Translate combo element found');
            
            // Check for cookie first, then saved language
            const cookies = document.cookie.split(';');
            const googtransCookie = cookies.find(function(c) {
                return c.trim().startsWith('googtrans=');
            });
            
            let langToApply = null;
            if (googtransCookie) {
                const cookieValue = googtransCookie.split('=')[1].trim();
                const parts = cookieValue.split('|');
                if (parts.length === 2 && parts[1] !== DEFAULT_LANGUAGE) {
                    langToApply = parts[1];
                    console.log('Found cookie, will apply language:', langToApply);
                }
            }
            
            if (!langToApply) {
                const savedLang = getSavedLanguage();
                if (savedLang !== DEFAULT_LANGUAGE) {
                    langToApply = savedLang;
                    setLanguageCookie(savedLang);
                    console.log('Using saved language:', langToApply);
                }
            }
            
            if (langToApply) {
                // Apply language via element
                setTimeout(function() {
                    if (translateInstance) {
                        try {
                            translateInstance.value = langToApply;
                            
                            // Try multiple event types
                            const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                            translateInstance.dispatchEvent(changeEvent);
                            
                            const inputEvent = new Event('input', { bubbles: true });
                            translateInstance.dispatchEvent(inputEvent);
                            
                            // Try native handler
                            if (typeof translateInstance.onchange === 'function') {
                                translateInstance.onchange();
                            }
                            
                            // Try jQuery if available
                            if (typeof jQuery !== 'undefined' && jQuery(translateInstance).length) {
                                jQuery(translateInstance).val(langToApply).trigger('change');
                            }
                            
                            // Try click
                            if (translateInstance.click) {
                                translateInstance.click();
                            }
                            
                            currentLanguage = langToApply;
                            updateLanguageSwitcher(langToApply);
                            
                            console.log('Applied language via element:', langToApply);
                        } catch (e) {
                            console.log('Could not change language via element:', e);
                        }
                    }
                }, 300);
            }
        } else if (retryCount < maxRetries) {
            // Retry after a delay
            setTimeout(function() {
                findAndApplyTranslateElement(retryCount + 1);
            }, 500);
        } else {
            console.warn('Google Translate combo element not found after', maxRetries, 'attempts');
        }
    }
    
    // Google Translate Element Init Callback
    function googleTranslateElementInit() {
        try {
            new google.translate.TranslateElement({
                pageLanguage: DEFAULT_LANGUAGE,
                includedLanguages: Object.keys(ALL_LANGUAGES).join(','),
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
            
            googleTranslateLoaded = true;
            console.log('Google Translate initialized successfully');
            
            hideTranslateBanner();
            
            // After initialization, find the combo element and apply saved language
            setTimeout(function() {
                findAndApplyTranslateElement();
            }, 1500);
        } catch (e) {
            console.error('Translate init error:', e);
            googleTranslateLoaded = false;
            hideTranslateBanner();
        }
    }
    
    // Load Google Translate with retry logic
    function loadGoogleTranslate(retry) {
        retry = retry || 0;
        const el = document.getElementById('google_translate_element');
        
        if (el) {
            // Check if Google Translate API is loaded
            if (window.google && window.google.translate) {
                googleTranslateElementInit();
            } else {
                // Script not loaded yet, wait a bit
                if (retry < 20) {
                    setTimeout(function() {
                        loadGoogleTranslate(retry + 1);
                    }, 500);
                } else {
                    console.error('Google Translate script not loaded after 10 seconds');
                }
            }
        } else if (retry < 10) {
            console.log('Translate element not ready, retrying...', retry + 1);
            setTimeout(function() {
                loadGoogleTranslate(retry + 1);
            }, 1000);
        } else {
            console.error('Google Translate element not found after 10 attempts.');
        }
    }
    
    // Initialize Google Translate with error handling
    function initGoogleTranslate() {
        if (googleTranslateLoaded) return;
        
        // Check for saved language and set cookie BEFORE loading script
        const savedLang = getSavedLanguage();
        if (savedLang !== DEFAULT_LANGUAGE) {
            setLanguageCookie(savedLang);
        }
        
        // Set up callback
        window.googleTranslateElementInit = googleTranslateElementInit;
        
        // Load Google Translate script
        const script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = '//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
        script.async = true;
        script.onerror = function() {
            console.warn('Google Translate script blocked by ad blocker or extension (ERR_BLOCKED_BY_CLIENT).');
            console.warn('Please disable adblocker/privacy extensions or whitelist this domain.');
            googleTranslateLoaded = false;
            hideTranslateBanner();
            
            // If script is blocked but we have a saved language, show a message
            if (savedLang !== DEFAULT_LANGUAGE) {
                console.warn('Translation may not work due to blocked script. Cookie is set but translation may not apply.');
                // Still try to reload with cookie as fallback
                if (!isReloading) {
                    console.log('Attempting to apply translation via cookie reload...');
                    isReloading = true;
                    setTimeout(function() {
                        window.location.reload();
                    }, 1000);
                }
            }
        };
        
        // Also check if script loads but gets blocked later
        script.onload = function() {
            console.log('Google Translate script loaded successfully');
        };
        
        document.head.appendChild(script);
        
        // Timeout check - if script doesn't load within 3 seconds, assume it's blocked
        setTimeout(function() {
            if (!googleTranslateLoaded && !isReloading) {
                console.warn('Google Translate script may be blocked. Checking...');
                // Check if script element is still in DOM but not loaded
                const scripts = document.querySelectorAll('script[src*="translate"]');
                scripts.forEach(function(s) {
                    if (s.src && !s.onerror && !window.google) {
                        console.warn('Script element exists but Google Translate API not available - likely blocked by extension');
                    }
                });
            }
        }, 3000);
        
        // Wait for DOM ready and start retry logic
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                loadGoogleTranslate();
            });
        } else {
            loadGoogleTranslate();
        }
        
        // Hide banner periodically
        setInterval(hideTranslateBanner, 1000);
    }
    
    // Change language programmatically
    function changeLanguage(lang) {
        console.log('Changing language to:', lang);
        
        // Prevent multiple calls
        if (isReloading) {
            console.log('Already reloading, skipping...');
            return;
        }
        
        // Save language preference first
        saveLanguage(lang);
        currentLanguage = lang;
        updateLanguageSwitcher(lang);
        
        // Set cookie (most reliable method)
        if (lang === DEFAULT_LANGUAGE) {
            // Clear cookie for English
            setLanguageCookie(DEFAULT_LANGUAGE);
        } else {
            // Set cookie for target language
            setLanguageCookie(lang);
        }
        
        // Always reload to ensure translation applies
        // This is the most reliable method
        console.log('Reloading page to apply translation...');
        isReloading = true;
        
        // Small delay to ensure cookie is set
        setTimeout(function() {
            window.location.reload();
        }, 300);
    }
    
    // Set Google Translate cookie (most reliable method)
    function setLanguageCookie(lang) {
        if (lang === DEFAULT_LANGUAGE) {
            // Clear cookie for English - try multiple ways
            const pastDate = 'Thu, 01 Jan 1970 00:00:00 UTC';
            document.cookie = 'googtrans=; expires=' + pastDate + '; path=/;';
            document.cookie = 'googtrans=; expires=' + pastDate + '; path=/; domain=' + window.location.hostname;
            if (window.location.hostname.indexOf('.') > 0) {
                const domain = '.' + window.location.hostname.split('.').slice(-2).join('.');
                document.cookie = 'googtrans=; expires=' + pastDate + '; path=/; domain=' + domain;
            }
            console.log('Cleared language cookie for English');
        } else {
            // Set cookie for target language: format is "en|bn" (from|to)
            const cookieValue = DEFAULT_LANGUAGE + '|' + lang;
            const expires = new Date();
            expires.setTime(expires.getTime() + (365 * 24 * 60 * 60 * 1000)); // 1 year
            const expiresString = expires.toUTCString();
            
            // Set cookie for root path (most important)
            document.cookie = 'googtrans=' + cookieValue + '; expires=' + expiresString + '; path=/; SameSite=Lax';
            
            // Also try without SameSite for compatibility
            document.cookie = 'googtrans=' + cookieValue + '; expires=' + expiresString + '; path=/';
            
            console.log('Set Google Translate cookie:', cookieValue);
            
            // Verify cookie was set
            setTimeout(function() {
                const cookies = document.cookie.split(';');
                const googtransCookie = cookies.find(function(c) {
                    return c.trim().startsWith('googtrans=');
                });
                if (googtransCookie) {
                    const value = googtransCookie.split('=')[1];
                    console.log('Cookie verified:', value);
                    if (value !== cookieValue) {
                        console.warn('Cookie value mismatch! Expected:', cookieValue, 'Got:', value);
                    }
                } else {
                    console.warn('Cookie not found after setting!');
                }
            }, 100);
        }
    }
    
    // Update language switcher UI
    function updateLanguageSwitcher(lang) {
        const switchers = [
            document.getElementById('languageSwitcher'),
            document.getElementById('languageSwitcherMobile')
        ].filter(function(switcher) { return switcher !== null; });
        
        if (switchers.length === 0) return;
        
        const currentLang = ALL_LANGUAGES[lang] || POPULAR_LANGUAGES[DEFAULT_LANGUAGE];
        
        switchers.forEach(function(switcher) {
            const button = switcher.querySelector('.language-switcher-button');
            const dropdown = switcher.querySelector('.language-switcher-dropdown');
            
            if (button) {
                const flagSpan = button.querySelector('.language-flag');
                const nameSpan = button.querySelector('.language-name');
                if (flagSpan) flagSpan.textContent = currentLang.flag;
                if (nameSpan) nameSpan.textContent = currentLang.name;
            }
            
            if (dropdown) {
                const items = dropdown.querySelectorAll('.language-item');
                items.forEach(function(item) {
                    const itemLang = item.getAttribute('data-lang');
                    if (itemLang === lang) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
        });
    }
    
    // Render language items
    function renderLanguageItems(container, languages, showSearch) {
        if (!container) return;
        
        container.innerHTML = '';
        
        // Add search box if showing all languages
        if (showSearch && showAllLanguages) {
            const searchBox = document.createElement('div');
            searchBox.className = 'language-search-box';
            searchBox.innerHTML = `
                <input type="text" class="language-search-input" placeholder="Search language..." autocomplete="off">
            `;
            container.appendChild(searchBox);
            
            const searchInput = searchBox.querySelector('.language-search-input');
            searchInput.addEventListener('input', function(e) {
                const query = e.target.value.toLowerCase().trim();
                const items = container.querySelectorAll('.language-item');
                items.forEach(function(item) {
                    const name = item.querySelector('.language-item-name').textContent.toLowerCase();
                    item.style.display = name.includes(query) ? '' : 'none';
                });
            });
        }
        
        // Add language items
        Object.keys(languages).forEach(function(langCode) {
            const lang = languages[langCode];
            const item = document.createElement('div');
            item.className = 'language-item';
            item.setAttribute('data-lang', langCode);
            if (currentLanguage === langCode) {
                item.classList.add('active');
            }
            item.innerHTML = `
                <span class="language-item-flag">${lang.flag}</span>
                <span class="language-item-name">${lang.name}</span>
            `;
            container.appendChild(item);
        });
        
        // Add "Show more" button if showing popular languages
        if (!showAllLanguages && Object.keys(languages).length < Object.keys(ALL_LANGUAGES).length) {
            const showMoreBtn = document.createElement('div');
            showMoreBtn.className = 'language-show-more';
            showMoreBtn.innerHTML = `
                <i class="fas fa-search"></i>
                <span>Search more languages...</span>
            `;
            showMoreBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                showAllLanguages = true;
                renderLanguageItems(container, ALL_LANGUAGES, true);
            });
            container.appendChild(showMoreBtn);
        }
    }
    
    // Initialize language switcher
    function initLanguageSwitcher() {
        const switchers = [
            document.getElementById('languageSwitcher'),
            document.getElementById('languageSwitcherMobile')
        ].filter(function(switcher) { return switcher !== null; });
        
        if (switchers.length === 0) return;
        
        switchers.forEach(function(switcher) {
            const button = switcher.querySelector('.language-switcher-button');
            const dropdown = switcher.querySelector('.language-switcher-dropdown');
            
            if (!button || !dropdown) return;
            
            // Initial render with popular languages
            renderLanguageItems(dropdown, POPULAR_LANGUAGES, false);
            
            // Toggle dropdown
            button.addEventListener('click', function(e) {
                e.stopPropagation();
                switchers.forEach(function(otherSwitcher) {
                    if (otherSwitcher !== switcher) {
                        otherSwitcher.querySelector('.language-switcher-dropdown').classList.remove('active');
                    }
                });
                dropdown.classList.toggle('active');
            });
            
            // Handle language selection
            dropdown.addEventListener('click', function(e) {
                const item = e.target.closest('.language-item');
                if (item) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const lang = item.getAttribute('data-lang');
                    if (lang) {
                        changeLanguage(lang);
                        switchers.forEach(function(s) {
                            s.querySelector('.language-switcher-dropdown').classList.remove('active');
                        });
                        
                        document.body.style.transition = 'opacity 0.3s ease';
                        document.body.style.opacity = '0.95';
                        setTimeout(function() {
                            document.body.style.opacity = '1';
                        }, 300);
                    }
                }
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            switchers.forEach(function(switcher) {
                if (!switcher.contains(e.target)) {
                    switcher.querySelector('.language-switcher-dropdown').classList.remove('active');
                }
            });
        });
        
        // Initialize with saved language
        const savedLang = getSavedLanguage();
        updateLanguageSwitcher(savedLang);
        currentLanguage = savedLang;
    }
    
    // Translate dynamic content
    function translateDynamicContent() {
        if (currentLanguage === DEFAULT_LANGUAGE || !googleTranslateLoaded) return;
        
        setTimeout(function() {
            if (translateInstance && currentLanguage !== DEFAULT_LANGUAGE) {
                try {
                    const tempLang = translateInstance.value;
                    translateInstance.value = '';
                    setTimeout(function() {
                        translateInstance.value = currentLanguage;
                        translateInstance.dispatchEvent(new Event('change'));
                    }, 50);
                } catch (e) {
                    // Ignore errors
                }
            }
        }, 300);
    }
    
    // Watch for AJAX updates
    function watchForAjaxUpdates() {
        if (window.Livewire) {
            document.addEventListener('livewire:navigated', function() {
                setTimeout(translateDynamicContent, 500);
            });
        }
        
        const observer = new MutationObserver(function(mutations) {
            let shouldTranslate = false;
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length > 0) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && 
                            (node.classList.contains('market-card') || 
                             node.classList.contains('outcome-row') ||
                             node.classList.contains('table') ||
                             node.querySelector('.market-card, .outcome-row, .table'))) {
                            shouldTranslate = true;
                        }
                    });
                }
            });
            
            if (shouldTranslate) {
                translateDynamicContent();
            }
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }
    
    // Initialize header menu language items
    function initHeaderMenuLanguageItems() {
        const desktopItem = document.getElementById('headerMenuLanguageItem');
        const mobileItem = document.getElementById('headerMenuLanguageItemMobile');
        const sidebarItem = document.getElementById('sidebarMenuLanguageItem');
        
        function handleLanguageMenuClick(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const headerMenu = document.getElementById('headerMenuDropdown');
            if (headerMenu) {
                headerMenu.classList.remove('active');
            }
            
            const sidebarMenu = document.getElementById('moreMenuSidebar');
            const sidebarOverlay = document.getElementById('moreMenuOverlay');
            if (sidebarMenu) {
                sidebarMenu.classList.remove('active');
            }
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('active');
            }
            if (document.body) {
                document.body.style.overflow = '';
            }
            
            const desktopSwitcher = document.getElementById('languageSwitcher');
            const mobileSwitcher = document.getElementById('languageSwitcherMobile');
            const activeSwitcher = desktopSwitcher || mobileSwitcher;
            
            if (activeSwitcher) {
                const dropdown = activeSwitcher.querySelector('.language-switcher-dropdown');
                if (dropdown) {
                    dropdown.classList.add('active');
                    if (mobileSwitcher && window.innerWidth <= 991) {
                        setTimeout(function() {
                            mobileSwitcher.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 100);
                    }
                }
            }
        }
        
        if (desktopItem) {
            desktopItem.addEventListener('click', handleLanguageMenuClick);
        }
        if (mobileItem) {
            mobileItem.addEventListener('click', handleLanguageMenuClick);
        }
        if (sidebarItem) {
            sidebarItem.addEventListener('click', handleLanguageMenuClick);
        }
    }
    
    // Check for existing cookie and apply translation
    function checkAndApplyCookie() {
        // First, try to find the element if not found yet
        if (!translateInstance) {
            translateInstance = document.querySelector('.goog-te-combo') || 
                               document.querySelector('select.goog-te-combo') ||
                               document.querySelector('#google_translate_element select') ||
                               document.querySelector('#google_translate_element .goog-te-combo');
        }
        
        const cookies = document.cookie.split(';');
        const googtransCookie = cookies.find(function(c) {
            return c.trim().startsWith('googtrans=');
        });
        
        if (googtransCookie) {
            const cookieValue = googtransCookie.split('=')[1].trim();
            const parts = cookieValue.split('|');
            if (parts.length === 2 && parts[1] !== DEFAULT_LANGUAGE) {
                const targetLang = parts[1];
                console.log('Found Google Translate cookie:', cookieValue, 'Target language:', targetLang);
                
                // Update current language
                currentLanguage = targetLang;
                updateLanguageSwitcher(targetLang);
                
                // If Google Translate element is available, apply translation
                if (translateInstance) {
                    try {
                        translateInstance.value = targetLang;
                        
                        // Try multiple event types
                        const changeEvent = new Event('change', { bubbles: true, cancelable: true });
                        translateInstance.dispatchEvent(changeEvent);
                        
                        const inputEvent = new Event('input', { bubbles: true });
                        translateInstance.dispatchEvent(inputEvent);
                        
                        // Try native handler
                        if (typeof translateInstance.onchange === 'function') {
                            translateInstance.onchange();
                        }
                        
                        // Try jQuery if available
                        if (typeof jQuery !== 'undefined' && jQuery(translateInstance).length) {
                            jQuery(translateInstance).val(targetLang).trigger('change');
                        }
                        
                        console.log('Applied translation from cookie via element:', targetLang);
                    } catch (e) {
                        console.log('Could not apply cookie via element:', e);
                    }
                } else {
                    console.log('Translate element not ready yet, will retry...');
                }
            }
        }
    }
    
        // Check if Google Translate is blocked
        function checkIfBlocked() {
            // Check for common blocking indicators
            const scripts = document.querySelectorAll('script[src*="translate"]');
            let isBlocked = false;
            
            scripts.forEach(function(script) {
                if (script.src && !window.google) {
                    // Script loaded but API not available
                    isBlocked = true;
                }
            });
            
            // Check network errors in console (if we can detect them)
            if (!googleTranslateLoaded && !window.google) {
                setTimeout(function() {
                    if (!googleTranslateLoaded) {
                        console.warn('âš ï¸ Google Translate may be blocked by adblocker/extension');
                        console.warn('ðŸ’¡ Solutions:');
                        console.warn('   1. Disable adblocker/privacy extensions temporarily');
                        console.warn('   2. Use Incognito/Private mode');
                        console.warn('   3. Whitelist this domain in your adblocker');
                        console.warn('   4. Check browser extensions (uBlock, Privacy Badger, etc.)');
                    }
                }, 5000);
            }
            
            return isBlocked;
        }
        
        // Initialize
        function init() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
                return;
            }
            
            // Check for saved language and set cookie BEFORE anything else
            const savedLang = getSavedLanguage();
            if (savedLang !== DEFAULT_LANGUAGE) {
                // Ensure cookie is set before Google Translate loads
                setLanguageCookie(savedLang);
                currentLanguage = savedLang;
            }
            
            initLanguageSwitcher();
            initHeaderMenuLanguageItems();
            initGoogleTranslate();
            watchForAjaxUpdates();
            
            // Check if blocked after a delay
            setTimeout(checkIfBlocked, 5000);
            
            // Check and apply cookie after Google Translate loads (multiple attempts)
            setTimeout(checkAndApplyCookie, 2000);
            setTimeout(checkAndApplyCookie, 4000);
            setTimeout(checkAndApplyCookie, 6000);
        }
    
    // Expose public API
    window.GoogleTranslateManager = {
        changeLanguage: changeLanguage,
        getCurrentLanguage: function() { return currentLanguage; },
        getLanguages: function() { return ALL_LANGUAGES; }
    };
    
    init();
})();
